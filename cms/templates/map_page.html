{% load wagtailcore_tags %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<h1>{{ page.title }}</h1>

{% if page.description %}
    <div class="page-description">
        {% include_block page.description %}
    </div>
{% endif %}

<div id="map" style="height: 500px;"></div>

<script>
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const bounds = [];

    {% for mp in page.map_points.all %}
    (() => {
        const lat = {{ mp.point.location.y|stringformat:"f" }};
        const lon = {{ mp.point.location.x|stringformat:"f" }};
        let msgHtml = "<b>Нет сообщений</b>";
        {% with msgs=mp.point.messages.all %}
            {% if msgs %}
                msgHtml = "<ul>{% for m in msgs %}<li>{{ m.text|escapejs }}</li>{% endfor %}</ul>";
            {% endif %}
        {% endwith %}

        L.marker([lat, lon]).addTo(map)
            .bindPopup(`<b>ID: {{ mp.point.pk }}</b><br>[${lat}, ${lon}]<hr>${msgHtml}`);
        bounds.push([lat, lon]);
    })();
    {% endfor %}

    if (bounds.length) map.fitBounds(bounds);
</script>